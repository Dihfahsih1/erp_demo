
{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content %}
    <div class="container-fluid">

  <h3>Customer Ledger - {{ sales_person }}</h3>

  <!-- Outstanding Balances -->
  <div class="mb-4">
    <h5>Outstanding Balances</h5>
    <div class="row">
      {% for cust in customers %}
        <div class="col-md-3 col-sm-6 mb-2">
          <div class="card border-danger">
            <div class="card-body p-2">
              <h6 class="card-title">{{ cust.customer_name }}</h6>
              <p class="card-text text-danger fw-bold">
                {{ outstanding.cust.name|default_if_none:"0"|floatformat:2|intcomma }}
              </p>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="mb-4">
  <h5>Ledger Summary</h5>
  <div class="row">
    <div class="col-md-3">
      <div class="card border-primary p-2">
        <h6>Total Debit</h6>
        <p id="totalDebit" class="fw-bold text-danger">0.00</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-success p-2">
        <h6>Total Credit</h6>
        <p id="totalCredit" class="fw-bold text-success">0.00</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-warning p-2">
        <h6>Outstanding</h6>
        <p id="totalOutstanding" class="fw-bold text-warning">0.00</p>
      </div>
    </div>
  </div>
</div>


  <!-- Filters -->
  <div class="row mb-3">
    <div class="col-md-3">
      <label for="start_date" class="form-label">Start Date</label>
      <input type="date" id="start_date" class="form-control" />
    </div>
    <div class="col-md-3">
      <label for="end_date" class="form-label">End Date</label>
      <input type="date" id="end_date" class="form-control" />
    </div>
    <div class="col-md-3">
      <label for="customer_filter" class="form-label">Customer</label>
      <select id="customer_filter" class="form-select">
        <option value="">All Customers</option>
        {% for cust in customers %}
          <option value="{{ cust.name }}">{{ cust.customer_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button id="filterBtn" class="btn btn-primary w-100">Filter</button>
    </div>
  </div>

  <!-- Ledger Table -->
    <table id="ledgerTable" class="table table-striped table-hover" style="width:100%">
        <thead class="table-dark">
        <tr>
            <th>Date <i class="bi bi-arrow-down-up"></i></th>
            <th>Customer Name <i class="bi bi-arrow-down-up"></i></th>
            <th>Debit <i class="bi bi-arrow-down-up"></i></th>
            <th>Credit <i class="bi bi-arrow-down-up"></i></th>
            <th>Voucher No</th>
            <th>Remarks</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
    </div>

        <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
        <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

        <script>
        function formatNumber(num) {
            return num.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        let ledgerTable = $('#ledgerTable').DataTable({
            dom: 'Bfrtip',
            buttons: [
            'csvHtml5',
            'pdfHtml5',
            'print'
            ],
            columns: [
            { data: 'posting_date' },
            { data: 'customer' },
            {
                data: 'debit',
                render: function (data) {
                return '<span class="text-danger">' + formatNumber(data || 0) + '</span>';
                }
            },
            {
                data: 'credit',
                render: function (data) {
                return '<span class="text-success">' + formatNumber(data || 0) + '</span>';
                }
            },
            { data: 'voucher_no' },
            { data: 'remarks' }
            ],
            order: [[0, 'desc']],
            pageLength: 10,
        });

        function loadData() {
            const start_date = $('#start_date').val();
            const end_date = $('#end_date').val();
            const customer = $('#customer_filter').val();

            $.ajax({
            url: '',
            data: { start_date, end_date, customer },
            dataType: 'json',
            success: function (res) {
                ledgerTable.clear();
                ledgerTable.rows.add(res.ledger_entries);
                ledgerTable.draw();

                // Update outstanding balances cards
                Object.entries(res.outstanding).forEach(([cust, amount]) => {
                let card = $(`div.card:has(h6:contains(${cust})) p.card-text`);
                if(card.length){
                    card.text(formatNumber(amount));
                }
                });
            },
            error: function () {
                alert('Failed to load ledger data.');
            }
            });
        }

        $(document).ready(function () {
            loadData();  // Load initial data

            $('#filterBtn').click(function () {
            loadData();
            });
        });



        let ledgerTable = $('#ledgerTable').DataTable({
        dom: 'Bfrtip',
        processing: true,
        serverSide: true,
        ajax: {
            url: '',
            data: function(d) {
            d.start_date = $('#start_date').val();
            d.end_date = $('#end_date').val();
            d.customer = $('#customer_filter').val();
            }
        },
        buttons: ['csvHtml5', 'pdfHtml5', 'print'],
        columns: [
            { data: 'posting_date' },
            { data: 'customer' },
            { 
            data: 'debit',
            render: data => `<span class="text-danger">${formatNumber(data || 0)}</span>`
            },
            { 
            data: 'credit',
            render: data => `<span class="text-success">${formatNumber(data || 0)}</span>`
            },
            { data: 'voucher_no' },
            { data: 'remarks' }
        ],
        order: [[0, 'desc']],
        pageLength: 10,
        drawCallback: function(settings) {
        const json = settings.json;
        if(json && json.outstanding) {
            Object.entries(json.outstanding).forEach(([cust, amount]) => {
            $(`div.card:has(h6:contains(${cust})) p.card-text`).text(formatNumber(amount));
            });

            // Calculate totals
            let totalDebit = 0, totalCredit = 0;
            if(json.ledger_entries) {
            json.ledger_entries.forEach(entry => {
                totalDebit += parseFloat(entry.debit || 0);
                totalCredit += parseFloat(entry.credit || 0);
            });
            }
            $('#totalDebit').text(formatNumber(totalDebit));
            $('#totalCredit').text(formatNumber(totalCredit));
            $('#totalOutstanding').text(formatNumber(totalDebit - totalCredit));
        }
        }

        });

        </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    let chartInstance;

    function renderOutstandingChart(outstandingData) {
        const ctx = document.getElementById('outstandingChart').getContext('2d');
        const labels = Object.keys(outstandingData);
        const data = Object.values(outstandingData).map(x => parseFloat(x.toFixed(2)));

        if(chartInstance) {
        chartInstance.data.labels = labels;
        chartInstance.data.datasets[0].data = data;
        chartInstance.update();
        } else {
        chartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
            labels,
            datasets: [{
                label: 'Outstanding Amount',
                data,
                backgroundColor: 'rgba(255, 159, 64, 0.7)',
                borderColor: 'rgba(255, 159, 64, 1)',
                borderWidth: 1
            }]
            },
            options: {
            scales: {
                y: {
                beginAtZero: true
                }
            }
            }
        });
        }
    }
    
    // Call after AJAX success in loadData
    function updateDashboard(outstanding) {
        // Update cards
        Object.entries(outstanding).forEach(([cust, amount]) => {
        $(`div.card:has(h6:contains(${cust})) p.card-text`).text(formatNumber(amount));
        });

        // Update chart
        renderOutstandingChart(outstanding);
    }

    // Modify loadData success
    function loadData() {
        const start_date = $('#start_date').val();
        const end_date = $('#end_date').val();
        const customer = $('#customer_filter').val();

        $.ajax({
        url: '',
        data: { start_date, end_date, customer },
        dataType: 'json',
        success: function (res) {
            ledgerTable.clear();
            ledgerTable.rows.add(res.ledger_entries);
            ledgerTable.draw();

            updateDashboard(res.outstanding);

            // Calculate totals as before...
        },
        error: function () {
            alert('Failed to load ledger data.');
        }
        });
    }
    </script>
        
    </div>

   


{% endblock content %}
