{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Upload Signed Delivery Note</h4>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="upload-form">
                        {% csrf_token %}
                        
                        <input type="hidden" name="delivery_status" value="{{ note.delivery_status }}">
                        <!-- Customer Information -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="receiver_name" class="form-label">Receiver Name</label>
                                <input type="text" class="form-control" id="receiver_name" name="receiver_name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="receiver_contact" class="form-label">Receiver Contact</label>
                                <input type="text" class="form-control" id="receiver_contact" name="receiver_contact">
                            </div>
                        </div>

                        <!-- Delivery Information -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="delivery_note_number" class="form-label">Delivery Note Number</label>
                                <input type="text" class="form-control" id="delivery_note_number" name="delivery_note_number" value="{{ note.delivery_note_number }}" readonly>
                            </div>
                            <div class="col-md-6">
                                <label for="date_of_receipt" class="form-label">Receiving Date</label>
                                <input type="date" class="form-control" id="date_of_receipt" name="date_of_receipt" value="{{ note.date_goods_received|date:'Y-m-d' }}">
                            </div>
                        </div>

                        <!-- Image Upload Section -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label">Delivery Note Images</label>
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="document.getElementById('images').click()">
                                    <i class="fas fa-plus me-1"></i> Add Files
                                </button>
                            </div>
                            
                            <div class="border border-2 rounded p-4 bg-light text-center" 
                                 id="drop-area"
                                 style="cursor:pointer; min-height: 150px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                <input type="file" name="images" id="images" accept="image/*" 
                                       class="d-none" multiple onchange="handleFiles(this.files)">
                                <div id="upload-prompt">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                                    <p class="mb-1">Drag & drop files here or</p>
                                    <button type="button" class="btn btn-sm btn-outline-primary">
                                        Browse Files
                                    </button>
                                </div>
                            </div>
                            
                            <!-- File preview cards -->
                            <div id="file-previews" class="mt-3">
                                <div class="row gy-3" id="file-cards-container"></div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button type="button" class="btn btn-primary btn-preview" onclick="showPreview()">
                                <i class="fas fa-eye me-2"></i>Preview
                            </button>
                            <button type="button" class="btn btn-success d-none" id="submit-btn" onclick="confirmSubmission()">
                                <i class="fas fa-check me-2"></i>Confirm & Submit
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="previewModalLabel">Delivery Note Preview</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Customer Details</h5>
                        <p><strong>Name:</strong> <span id="preview-customer-name"></span></p>
                        <p><strong>Address:</strong> <span id="preview-customer-address"></span></p>
                    </div>
                    <div class="col-md-6">
                        <h5>Delivery Details</h5>
                        <p><strong>Note Number:</strong> <span id="preview-estimate-number"></span></p>
                        <p><strong>Delivery Date:</strong> <span id="preview-delivery-date"></span></p>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h5 class="text-center mb-3">Uploaded Images</h5>
                    <div id="modal-preview-images" class="row g-3"></div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Edit Details</button>
                <button type="button" class="btn btn-primary" onclick="confirmSubmission()">Confirm & Submit</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Global variable to store uploaded files
    let uploadedFiles = [];
    
    // Handle file selection
    function handleFiles(files) {
        console.log('handleFiles function called with', files.length, 'files');
        
        if (files.length === 0) return;
        
        // Add new files to existing ones
        uploadedFiles = [...uploadedFiles, ...Array.from(files)];
        renderFileCards();
    }
    
    // Render file cards
    function renderFileCards() {
        const container = document.getElementById('file-cards-container');
        const dropArea = document.getElementById('drop-area');
        const uploadPrompt = document.getElementById('upload-prompt');
        
        // Clear previous cards
        container.innerHTML = '';
        
        if (uploadedFiles.length === 0) {
            dropArea.style.minHeight = '150px';
            uploadPrompt.classList.remove('d-none');
            return;
        }
        
        // Hide the upload prompt if we have files
        uploadPrompt.classList.add('d-none');
        dropArea.style.minHeight = 'auto';
        
        // Create cards for each file
        uploadedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const col = document.createElement('div');
                col.className = 'col-12 col-md-6 col-lg-4';
                
                const card = document.createElement('div');
                card.className = 'card h-100';
                
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'card-img-top';
                img.style.height = '150px';
                img.style.objectFit = 'contain';
                img.style.backgroundColor = '#f8f9fa';
                
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body p-3';
                
                const fileName = document.createElement('p');
                fileName.className = 'card-text text-truncate mb-1';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('small');
                fileSize.className = 'text-muted';
                fileSize.textContent = formatFileSize(file.size);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn btn-danger btn-sm w-100 mt-2';
                removeBtn.innerHTML = '<i class="fas fa-trash me-1"></i> Remove';
                removeBtn.onclick = (e) => {
                    e.preventDefault();
                    removeFile(index);
                };
                
                cardBody.appendChild(fileName);
                cardBody.appendChild(fileSize);
                cardBody.appendChild(removeBtn);
                
                card.appendChild(img);
                card.appendChild(cardBody);
                col.appendChild(card);
                container.appendChild(col);
            };
            reader.readAsDataURL(file);
        });
    }
    
    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    
    // Remove file from list
    function removeFile(index) {
        uploadedFiles.splice(index, 1);
        renderFileCards();
    }
    
    // Drag and drop functionality
    document.addEventListener('DOMContentLoaded', function() {
        const dropArea = document.getElementById('drop-area');
        
        // Prevent default drag behaviors
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        // Highlight drop area when item is dragged over it
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        // Handle dropped files
        dropArea.addEventListener('drop', handleDrop, false);
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        function highlight() {
            dropArea.classList.add('border-primary');
            dropArea.style.backgroundColor = 'rgba(13, 110, 253, 0.1)';
        }
        
        function unhighlight() {
            dropArea.classList.remove('border-primary');
            dropArea.style.backgroundColor = '';
        }
        
        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }
    });
    
    // Show preview modal
    function showPreview() {
        console.log('showPreview function called');
        
        // Validate required fields
        const customerName = document.getElementById('receiver_name').value;
        const estimateNumber = document.getElementById('delivery_note_number').value;
        const deliveryDate = document.getElementById('date_of_receipt').value;
        
        console.log('Form values:', {
            customerName,
            estimateNumber,
            deliveryDate,
            files: uploadedFiles.length
        });
        
        if (!customerName || !deliveryDate || !estimateNumber || uploadedFiles.length === 0) {
            const missingFields = [];
            if (!customerName) missingFields.push('Receiver Name');
            if (!deliveryDate) missingFields.push('Delivery Date');
            if (!estimateNumber) missingFields.push('Delivery Note Number');
            if (uploadedFiles.length === 0) missingFields.push('Images');
            
            console.warn('Missing required fields:', missingFields);
            alert('Please fill all required fields: ' + missingFields.join(', '));
            return false;
        }
    
        // Populate preview modal
        document.getElementById('preview-customer-name').textContent = customerName;
        document.getElementById('preview-customer-address').textContent = document.getElementById('receiver_contact').value;
        document.getElementById('preview-estimate-number').textContent = estimateNumber;
        document.getElementById('preview-delivery-date').textContent = deliveryDate;
        
        // Clear previous images in modal
        const modalPreviewContainer = document.getElementById('modal-preview-images');
        modalPreviewContainer.innerHTML = '';
        
        // Add images to modal
        uploadedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const col = document.createElement('div');
                col.className = 'col-md-6';
                
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'img-fluid rounded border';
                img.style.maxHeight = '300px';
                img.style.width = '100%';
                img.style.objectFit = 'contain';
                
                col.appendChild(img);
                modalPreviewContainer.appendChild(col);
            };
            reader.readAsDataURL(file);
        });
        
        // Show modal
        try {
            const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
            previewModal.show();
            console.log('Preview modal shown');
        } catch (e) {
            console.error('Error showing preview modal:', e);
        }
        
        return false; // Prevent default form submission
    }
    
    // Confirm submission
    function confirmSubmission() {
        console.log('confirmSubmission function called');
        try {
            // Create FormData and append all fields
            const form = document.getElementById('upload-form');
            const formData = new FormData(form);
            
            // Append all files
            uploadedFiles.forEach((file, index) => {
                formData.append('images', file);
            });
            
            // Hide modal first
            const previewModal = bootstrap.Modal.getInstance(document.getElementById('previewModal'));
            if (previewModal) {
                previewModal.hide();
            }
            
            // Submit form via fetch
            submitFormData(form.action, formData);
        } catch (e) {
            console.error('Error in confirmSubmission:', e);
        }
    }

    // Dedicated function for form submission
    async function submitFormData(url, formData) {
        console.log('Starting form submission');
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest',
                }
            });
            
            console.log('Response status:', response.status);
            
            const data = await response.json();
            console.log('Response data:', data);
            
            if (data.success) {
                console.log('Submission successful, redirecting...');
                window.location.href = data.redirect_url;
            } else {
                console.warn('Submission failed with errors:', data.errors);
                displayFormErrors(data.errors);
                alert(data.message || "Please correct the errors below.");
            }
        } catch (error) {
            console.error('Submission error:', error);
            alert('An error occurred while submitting the form');
        }
    }
    
    // Function to display form errors
    function displayFormErrors(errors) {
        // Clear previous errors
        document.querySelectorAll('.is-invalid').forEach(el => {
            el.classList.remove('is-invalid');
        });
        document.querySelectorAll('.invalid-feedback').forEach(el => {
            el.remove();
        });
        
        if (errors) {
            for (const [field, error] of Object.entries(errors)) {
                console.log(`Error for field ${field}:`, error);
                const input = document.querySelector(`[name="${field}"]`) || 
                            document.querySelector(`#id_${field}`) || 
                            document.querySelector(`#${field}`);
                
                if (input) {
                    input.classList.add('is-invalid');
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'invalid-feedback';
                    errorDiv.textContent = Array.isArray(error) ? error.join(' ') : error;
                    input.parentNode.appendChild(errorDiv);
                } else {
                    console.warn(`Could not find input element for field: ${field}`);
                }
            }
        }
    }
</script>

<style>
    #drop-area {
        transition: all 0.3s ease;
        border-style: dashed;
    }
    
    #drop-area.highlight {
        border-color: #0d6efd !important;
        background-color: rgba(13, 110, 253, 0.1) !important;
    }
    
    .card-img-top {
        border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    #file-previews {
        display: none;
    }
    
    #file-previews:not(:empty) {
        display: block;
    }
</style>
{% endblock %}