<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Salesperson Dashboard - Customer Ledger</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
        <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
        <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
        <style>
            :root {
                --primary-color: #3498db;
                --secondary-color: #2c3e50;
                --accent-color: #e74c3c;
                --light-bg: #f8f9fa;
                --success-color: #2ecc71;
                --warning-color: #f39c12;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                background-color: #f5f7fa;
            }

            .sidebar {
                background-color: var(--secondary-color);
                color: white;
                height: 100vh;
                position: fixed;
                padding-top: 20px;
                width: 250px;
            }

            .sidebar .nav-link {
                color: rgba(255, 255, 255, 0.8);
                margin-bottom: 5px;
                border-radius: 5px;
                padding: 10px 15px;
            }

            .sidebar .nav-link:hover {
                background-color: rgba(255, 255, 255, 0.1);
                color: white;
            }

            .sidebar .nav-link.active {
                background-color: var(--primary-color);
                color: white;
            }

            .sidebar .nav-link i {
                margin-right: 10px;
            }

            .main-content {
                margin-left: 250px;
                padding: 20px;
            }

            .card {
                border: none;
                border-radius: 10px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                transition: transform 0.3s ease;
                margin-bottom: 20px;
            }

            .card:hover {
                transform: translateY(-5px);
            }

            .card-header {
                background-color: white;
                border-bottom: 1px solid rgba(0, 0, 0, 0.05);
                font-weight: 600;
                border-radius: 10px 10px 0 0 !important;
            }

            .top-bar {
                background-color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                margin-bottom: 20px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .search-bar {
                width: 300px;
            }

            .user-profile {
                display: flex;
                align-items: center;
            }

            .user-profile img {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                margin-right: 10px;
            }

            .filter-group {
                margin-bottom: 20px;
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                align-items: center;
            }

            .filter-group select, .filter-group input {
                margin-right: 10px;
            }

            .chart-container {
                position: relative;
                height: 300px;
            }

            .slider-container {
                width: 200px;
                display: inline-block;
            }

            .table-responsive {
                margin-top: 20px;
            }

            .table th, .table td {
                vertical-align: middle;
            }

            .clickable-row {
                cursor: pointer;
            }

            .clickable-row:hover {
                background-color: #f1f1f1;
            }

            .modal-lg {
                max-width: 900px;
            }

            .badge-slow-moving {
                background-color: var(--warning-color);
                color: white;
                padding: 5px 10px;
                border-radius: 20px;
                font-size: 0.8rem;
            }

            .export-btn {
                margin-left: 10px;
            }
        </style>
    </head>
    <body>
        <div class="sidebar col-md-3 col-lg-2 d-md-block">
            <div class="text-center mb-4">
                <h4><i class="bi bi-speedometer2"></i> Salesperson Dashboard</h4>
                <p class="text-muted small">Document Search</p>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="sales_person_performance.html">
                        <i class="bi bi-speedometer2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="sales_person_customers.html">
                        <i class="bi bi-person-lines-fill"></i> Customers
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="sales_person_ageing.html">
                        <i class="bi bi-file-earmark-text"></i> Ageing Report
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="sales_person_document.html">
                        <i class="bi bi-search"></i> Document Search
                    </a>
                </li>
                <li class="nav-item mt-3">
                    <a class="nav-link active" href="sales_person_customer_ledger.html">
                        <i class="bi bi-gear"></i> Customer Ledger
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">
                        <i class="bi bi-box-arrow-right"></i> Logout
                    </a>
                </li>
            </ul>
        </div>

        <div class="main-content">
            <div class="top-bar">
                <div class="search-bar">
                    <div class="input-group">
                        <input type="text" id="keywordSearch" class="form-control" placeholder="Search customers...">
                        <button class="btn btn-outline-secondary" type="button">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="user-profile">
                    <img src="placeholder.png" alt="User">
                    <div>
                        <div class="fw-bold">Office Sales</div>
                        <div class="text-muted small">Salesperson - Central Region</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <h4 class="mb-4">Customer Ledger Dashboard</h4>
                </div>
            </div>

            <div class="filter-group">
                <label class="form-label me-2">Filters:</label>
                <select id="brandFilter" class="form-select d-inline-block w-auto">
                    <option value="all">All Brands</option>
                    <option value="brandA">Brand A</option>
                    <option value="brandB">Brand B</option>
                    <option value="brandC">Brand C</option>
                </select>
                <select id="regionFilter" class="form-select d-inline-block w-auto">
                    <option value="all">All Districts/Routes</option>
                    <option value="district1">District 1</option>
                    <option value="district2">District 2</option>
                    <option value="routeA">Route A</option>
                    <option value="routeB">Route B</option>
                </select>
                <select id="billingFilter" class="form-select d-inline-block w-auto">
                    <option value="all">All Billing Frequencies</option>
                    <option value="weekly">Weekly</option>
                    <option value="monthly">Monthly</option>
                    <option value="quarterly">Quarterly</option>
                    <option value="yearly">Yearly</option>
                </select>
                <div class="input-group w-auto">
                    <span class="input-group-text">From</span>
                    <input type="date" id="startDate" class="form-control" value="2025-01-30">
                    <span class="input-group-text">To</span>
                    <input type="date" id="endDate" class="form-control" value="2025-07-30">
                </div>
                <div class="slider-container">
                    <label for="outstandingSlider" class="form-label">Min Outstanding (K)</label>
                    <input type="range" id="outstandingSlider" class="form-range" min="0" max="2000" value="0">
                    <span id="sliderValue">0K</span>
                </div>
                <button id="applyFilters" class="btn btn-primary">Apply Filters</button>
                <button id="exportTable" class="btn btn-success export-btn">
                    <i class="bi bi-file-earmark-excel"></i> Export to CSV
                </button>
            </div>

            <div class="row">
                <!-- Total Order Amount Bar Chart -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            Total Order Amount by Customer
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="orderAmountChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Slow-Moving Items Pie Chart -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            Slow-Moving Items Distribution
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="slowMovingChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <!-- Customer Ledger Table -->
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            Customer Ledger Overview
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="customerTable" class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Customer Name</th>
                                            <th>Sales Orders</th>
                                            <th>Total Order Amount (K)</th>
                                            <th>Slow-Moving Items</th>
                                            <th>Outstanding Balance (K)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr class="clickable-row" data-customer-id="1">
                                            <td>Acme Corporation</td>
                                            <td>5</td>
                                            <td>1250</td>
                                            <td>2 <span class="badge badge-slow-moving">Low Velocity</span></td>
                                            <td>750</td>
                                        </tr>
                                        <tr class="clickable-row" data-customer-id="2">
                                            <td>Beta Enterprises</td>
                                            <td>6</td>
                                            <td>1800</td>
                                            <td>1 <span class="badge badge-slow-moving">Low Velocity</span></td>
                                            <td>1200</td>
                                        </tr>
                                        <tr class="clickable-row" data-customer-id="3">
                                            <td>Gamma Retail</td>
                                            <td>4</td>
                                            <td>800</td>
                                            <td>3 <span class="badge badge-slow-moving">Low Velocity</span></td>
                                            <td>500</td>
                                        </tr>
                                        <tr class="clickable-row" data-customer-id="4">
                                            <td>Delta Traders</td>
                                            <td>5</td>
                                            <td>1500</td>
                                            <td>0</td>
                                            <td>900</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Ledger Modal -->
            <div class="modal fade" id="ledgerModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="ledgerModalTitle">Customer Ledger</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Ledger Entries (Last 6 Months)</h6>
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Type</th>
                                                <th>Amount (K)</th>
                                                <th>Balance (K)</th>
                                                <th>Remarks</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ledgerTableBody">
                                            <!-- Populated dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="col-md-6">
                                    <h6>Outstanding Balance Trend</h6>
                                    <div class="chart-container">
                                        <canvas id="ledgerTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-md-12">
                                    <h6>Slow-Moving Items</h6>
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Item Name</th>
                                                <th>Units Sold</th>
                                                <th>Last Sale Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="slowMovingTableBody">
                                            <!-- Populated dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-success" onclick="window.print()">
                                <i class="bi bi-printer"></i> Print
                            </button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            // Dummy data for charts and tables (updated by filters)
            let customerData = [
                { id: 1, name: 'Acme Corporation', orders: 5, totalAmount: 1250, slowMoving: 2, outstanding: 750, brand: 'brandA', region: 'district1', billing: 'monthly' },
                { id: 2, name: 'Beta Enterprises', orders: 6, totalAmount: 1800, slowMoving: 1, outstanding: 1200, brand: 'brandB', region: 'district2', billing: 'quarterly' },
                { id: 3, name: 'Gamma Retail', orders: 4, totalAmount: 800, slowMoving: 3, outstanding: 500, brand: 'brandA', region: 'routeA', billing: 'monthly' },
                { id: 4, name: 'Delta Traders', orders: 5, totalAmount: 1500, slowMoving: 0, outstanding: 900, brand: 'brandC', region: 'routeB', billing: 'weekly' }
            ];

            let ledgerData = {
                1: [
                    { date: '2025-01-15', type: 'Credit', amount: 500, balance: 750, remarks: 'Invoice INV-001' },
                    { date: '2025-02-10', type: 'Debit', amount: 250, balance: 500, remarks: 'Payment received' },
                    { date: '2025-03-20', type: 'Credit', amount: 300, balance: 800, remarks: 'Invoice INV-002' },
                    { date: '2025-05-10', type: 'Debit', amount: 50, balance: 750, remarks: 'Partial payment' }
                ],
                2: [
                    { date: '2025-02-01', type: 'Credit', amount: 1000, balance: 1200, remarks: 'Invoice INV-003' },
                    { date: '2025-03-15', type: 'Debit', amount: 200, balance: 1000, remarks: 'Payment received' },
                    { date: '2025-04-20', type: 'Credit', amount: 400, balance: 1400, remarks: 'Invoice INV-004' }
                ],
                3: [
                    { date: '2025-03-05', type: 'Credit', amount: 300, balance: 500, remarks: 'Invoice INV-005' },
                    { date: '2025-04-10', type: 'Debit', amount: 100, balance: 400, remarks: 'Payment received' }
                ],
                4: [
                    { date: '2025-02-20', type: 'Credit', amount: 600, balance: 900, remarks: 'Invoice INV-006' },
                    { date: '2025-05-15', type: 'Debit', amount: 300, balance: 600, remarks: 'Payment received' }
                ]
            };

            let slowMovingData = {
                1: [
                    { item: 'Brake Pads', unitsSold: 3, lastSale: '2025-02-15' },
                    { item: 'Oil Filter', unitsSold: 2, lastSale: '2025-03-10' }
                ],
                2: [
                    { item: 'Spark Plugs', unitsSold: 4, lastSale: '2025-04-05' }
                ],
                3: [
                    { item: 'Air Filter', unitsSold: 2, lastSale: '2025-03-20' },
                    { item: 'Wiper Blades', unitsSold: 3, lastSale: '2025-02-25' },
                    { item: 'Battery', unitsSold: 1, lastSale: '2025-01-30' }
                ],
                4: []
            };

            let orderAmountData = {
                'all': customerData.map(c => c.totalAmount),
                'brandA': [1250, 0, 800, 0],
                'brandB': [0, 1800, 0, 0],
                'brandC': [0, 0, 0, 1500]
            };

            let slowMovingDistData = {
                'all': customerData.map(c => c.slowMoving),
                'brandA': [2, 0, 3, 0],
                'brandB': [0, 1, 0, 0],
                'brandC': [0, 0, 0, 0]
            };

            let balanceTrendData = {
                1: [500, 750, 500, 800, 750, 750],
                2: [800, 1200, 1000, 1400, 1400, 1200],
                3: [300, 400, 500, 400, 400, 500],
                4: [600, 900, 600, 600, 900, 600]
            };

            // Total Order Amount Bar Chart
            const orderAmountChart = new Chart(document.getElementById('orderAmountChart'), {
                type: 'bar',
                data: {
                    labels: customerData.map(c => c.name),
                    datasets: [{
                        label: 'Total Order Amount (K)',
                        data: orderAmountData['all'],
                        backgroundColor: 'rgba(52, 152, 219, 0.5)',
                        borderColor: 'rgba(52, 152, 219, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Amount (K)' }
                        }
                    },
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Total Order Amount by Customer' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y}K`;
                                }
                            }
                        }
                    }
                }
            });

            // Slow-Moving Items Pie Chart
            const slowMovingChart = new Chart(document.getElementById('slowMovingChart'), {
                type: 'pie',
                data: {
                    labels: customerData.map(c => c.name),
                    datasets: [{
                        label: 'Slow-Moving Items',
                        data: slowMovingDistData['all'],
                        backgroundColor: [
                            'rgba(52, 152, 219, 0.5)',
                            'rgba(46, 204, 113, 0.5)',
                            'rgba(231, 76, 60, 0.5)',
                            'rgba(243, 156, 18, 0.5)'
                        ],
                        borderColor: [
                            'rgba(52, 152, 219, 1)',
                            'rgba(46, 204, 113, 1)',
                            'rgba(231, 76, 60, 1)',
                            'rgba(243, 156, 18, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Slow-Moving Items by Customer' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed} items`;
                                }
                            }
                        }
                    }
                }
            });

            // Ledger Trend Chart (Initialized in Modal)
            let ledgerTrendChart = null;

            $(document).ready(function() {
                const table = $('#customerTable').DataTable({
                    paging: true,
                    searching: true,
                    ordering: true,
                    info: false,
                    pageLength: 5,
                    lengthChange: false,
                    order: [[4, 'desc']] // Default sort by Outstanding Balance
                });

                // Clickable rows for ledger modal
                $('#customerTable').on('click', '.clickable-row', function() {
                    const customerId = $(this).data('customer-id');
                    const customerName = $(this).find('td').eq(0).text();
                    $('#ledgerModalTitle').text(`Customer Ledger: ${customerName}`);

                    // Populate ledger table
                    const ledgerRows = ledgerData[customerId].map(row => `
                        <tr>
                            <td>${row.date}</td>
                            <td>${row.type}</td>
                            <td>${row.amount}</td>
                            <td>${row.balance}</td>
                            <td>${row.remarks}</td>
                        </tr>
                    `).join('');
                    $('#ledgerTableBody').html(ledgerRows);

                    // Populate slow-moving items table
                    const slowMovingRows = slowMovingData[customerId].map(item => `
                        <tr>
                            <td>${item.item}</td>
                            <td>${item.unitsSold}</td>
                            <td>${item.lastSale}</td>
                        </tr>
                    `).join('');
                    $('#slowMovingTableBody').html(slowMovingRows || '<tr><td colspan="3">No slow-moving items</td></tr>');

                    // Initialize or update ledger trend chart
                    if (ledgerTrendChart) ledgerTrendChart.destroy();
                    ledgerTrendChart = new Chart(document.getElementById('ledgerTrendChart'), {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                            datasets: [{
                                label: 'Outstanding Balance (K)',
                                data: balanceTrendData[customerId],
                                fill: false,
                                borderColor: 'rgba(46, 204, 113, 1)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Balance (K)' }
                                }
                            },
                            plugins: {
                                legend: { position: 'top' },
                                title: { display: true, text: 'Outstanding Balance Trend (Last 6 Months)' }
                            }
                        }
                    });

                    const ledgerModal = new bootstrap.Modal(document.getElementById('ledgerModal'));
                    ledgerModal.show();
                });

                // Update slider value display
                $('#outstandingSlider').on('input', function() {
                    $('#sliderValue').text($(this).val() + 'K');
                });

                // Apply filters and update visualizations
                $('#applyFilters').on('click', function() {
                    const brand = $('#brandFilter').val();
                    const region = $('#regionFilter').val();
                    const billing = $('#billingFilter').val();
                    const startDate = $('#startDate').val();
                    const endDate = $('#endDate').val();
                    const minOutstanding = parseInt($('#outstandingSlider').val());
                    const keyword = $('#keywordSearch').val().toLowerCase();

                    // Filter customer data
                    let filteredData = customerData.filter(c => {
                        return (brand === 'all' || c.brand === brand) &&
                            (region === 'all' || c.region === region) &&
                            (billing === 'all' || c.billing === billing) &&
                            c.outstanding >= minOutstanding &&
                            (keyword === '' || c.name.toLowerCase().includes(keyword)) &&
                            (!startDate || '2025-01-30' >= startDate) &&
                            (!endDate || '2025-07-30' <= endDate);
                    });

                    // Update charts
                    orderAmountChart.data.datasets[0].data = orderAmountData[brand] || orderAmountData['all'];
                    orderAmountChart.data.labels = filteredData.map(c => c.name);
                    orderAmountChart.update();

                    slowMovingChart.data.datasets[0].data = slowMovingDistData[brand] || slowMovingDistData['all'];
                    slowMovingChart.data.labels = filteredData.map(c => c.name);
                    slowMovingChart.update();

                    // Update table
                    table.clear().rows.add(filteredData.map(c => [
                        c.name,
                        c.orders,
                        c.totalAmount,
                        c.slowMoving ? `${c.slowMoving} <span class="badge badge-slow-moving">Low Velocity</span>` : '0',
                        c.outstanding
                    ])).draw();
                });

                // Trigger filter on keyword search enter
                $('#keywordSearch').on('keypress', function(e) {
                    if (e.which === 13) {
                        $('#applyFilters').click();
                    }
                });

                // Export table to CSV
                $('#exportTable').on('click', function() {
                    let csv = 'Customer Name,Sales Orders,Total Order Amount (K),Slow-Moving Items,Outstanding Balance (K)\n';
                    const rows = table.rows().data();
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        csv += `"${row[0]}",${row[1]},${row[2]},${row[3].replace(/<[^>]+>/g, '')},${row[4]}\n`;
                    }
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.setAttribute('href', url);
                    a.setAttribute('download', 'customer_ledger.csv');
                    a.click();
                });
            });
        </script>
    </body>
</html>